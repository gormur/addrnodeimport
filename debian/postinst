#!/bin/sh
# postinst script for addrnodeimport
#
# see: dh_installdeb(1)

set -e

. /usr/share/debconf/confmodule

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
        db_get addrnodeimport/db-name
        DBNAME=$RET
        db_get addrnodeimport/db-password
        PASSWORD=$RET
        db_get addrnodeimport/db-user
        DBUSER=$RET
        db_get addrnodeimport/root-password
        ROOTPASSWORD=$RET
        db_get addrnodeimport/osm-import-user
        OSMUSER=$RET
        db_get addrnodeimport/osm-import-pass
        OSMPASS=$RET
        sed -i 's/DBNAME=.*$/DBNAME='$DBNAME'/' /etc/addrnodeimport.conf
        sed -i 's/DBUSER=.*$/DBUSER='$DBUSER'/' /etc/addrnodeimport.conf
        sed -i 's/DBPASS=.*$/DBPASS='$PASSWORD'/' /etc/addrnodeimport.conf
        sed -i "s/\$dbuser = .*$/\$dbuser = '"$DBUSER"';/" /usr/share/websites/addrnodeimport/www/mysql.php
        sed -i "s/\$dbpass = .*$/\$dbpass = '"$PASSWORD"';/" /usr/share/websites/addrnodeimport/www/mysql.php
        sed -i "s/\$dbname = .*$/\$dbname = '"$DBNAME"';/" /usr/share/websites/addrnodeimport/www/mysql.php
        sed -i "s/sqldbname = .*$/sqldbname = '"$DBNAME"';/" /usr/lib/addrnodeimport/python/mypasswords.py
        sed -i "s/sql = .*$/sql = '"$PASSWORD"';/" /usr/lib/addrnodeimport/python/mypasswords.py
        sed -i "s/sqldbuser = .*$/sqldbuser = '"$DBUSER"';/" /usr/lib/addrnodeimport/python/mypasswords.py
        sed -i "s/osm = .*$/osm = '"$OSMPASS"';/" /usr/lib/addrnodeimport/python/mypasswords.py
        sed -i "s/osmuser = .*$/osmuser = '"$OSMUSER"';/" /usr/lib/addrnodeimport/python/mypasswords.py
        RES=$(echo "select schema_name from information_schema.schemata where schema_name = '$DBNAME';" | mysql -h localhost -u root -p$ROOTPASSWORD mysql)
        if [ "$RES" = "" ] ; then
            echo "Database does not exist. Creating..."
            echo "create database $DBNAME;" | mysql -h localhost -u root -p$ROOTPASSWORD mysql
            echo "grant all on ${DBNAME}.* to ${DBUSER} identified by '${PASSWORD}';" | mysql -h localhost -u root -p$ROOTPASSWORD mysql
            /usr/bin/addrnodeimport_import_sql_backup /usr/share/doc/addrnodeimport/tables.sql
        else
            echo "Database $DBNAME exists already. Skipping setup"
        fi
        db_get addrnodeimport/enable
        ENABLENOW=$RET
        if [ "$ENABLENOW" = "true" ] ; then
            echo "Enabling site now"
            a2ensite addrnodeimport-site.conf
        fi
        chown -R addrnodeimport:addrnodeimport /var/cache/addrnodeimport
        #tar -xf /usr/share/addrnodeimport/municipality_borders.tar.gz -C /usr/share/addrnodeimport
        #mv /usr/share/addrnodeimport/osm /usr/share/addrnodeimport/municipality_borders
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
